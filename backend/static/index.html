<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fridge Tracker</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    h1 { margin: 0 0 12px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input { padding: 8px; font-size: 14px; }
    button { padding: 8px 12px; font-size: 14px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; }
    .muted { color: #666; font-size: 12px; }
    img { margin-top: 16px; border: 1px solid #ddd; max-width: 100%; }
  </style>
</head>
<body>
  <h1>冰箱管理</h1>
  <div class="muted">添加/删除后会自动刷新列表与 Top10 图片</div>

  <div class="row" style="margin-top:12px;">
    <input id="name" placeholder="名称（例如：鸡蛋）" />
    <input id="date_in" type="date" />
    <button onclick="addItem()">添加</button>
  </div>

  <table>
    <thead>
      <tr><th>名称</th><th>入冰箱日期</th><th>ID</th><th>操作</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <h2 style="margin-top:18px;">Top10</h2>
  <img id="top10" src="/top10.png" alt="top10" />

<script>
async function refresh() {
  const r = await fetch("/items");
  const data = await r.json();
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  for (const it of data.items) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(it.name)}</td>
      <td>${it.date_in}</td>
      <td class="muted">${it.id}</td>
      <td><button onclick="delItem('${it.id}')">删除</button></td>
    `;
    tbody.appendChild(tr);
  }

  // 强制刷新图片（加时间戳避免缓存）
  document.getElementById("top10").src = "/top10.png?t=" + Date.now();
}

async function addItem() {
  const name = document.getElementById("name").value.trim();
  const date_in = document.getElementById("date_in").value;

  if (!name) { alert("请填写名称"); return; }

  const payload = date_in ? { name, date_in } : { name };

  const r = await fetch("/items", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!r.ok) {
    const err = await r.json().catch(()=>({detail:"unknown"}));
    alert("添加失败: " + (err.detail || r.status));
    return;
  }

  document.getElementById("name").value = "";
  await refresh();
}

async function delItem(id) {
  const r = await fetch("/items/" + id, { method: "DELETE" });
  if (!r.ok) {
    const err = await r.json().catch(()=>({detail:"unknown"}));
    alert("删除失败: " + (err.detail || r.status));
    return;
  }
  await refresh();
}

function escapeHtml(s) {
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

refresh();
</script>
</body>
</html>
